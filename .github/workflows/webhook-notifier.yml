name: Webhook Event Notifier

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - closed
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Prepare event data
      id: prepare-data
      run: |
        echo "=== 开始准备事件数据 ==="
        echo "事件类型: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "Push事件: 比较 ${{ github.event.before }}..${{ github.sha }}"
          # 获取变更文件列表并限制最多50个
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>&1 | head -50 | tr '\n' ',' | sed 's/,$//')
          echo "变更文件: $CHANGED_FILES"
          
          echo '{"event_type": "push", "repository": "${{ github.repository }}", "branch": "${{ github.ref_name }}", "commit_sha": "${{ github.sha }}", "pusher": "${{ github.actor }}", "changed_files": "'"$CHANGED_FILES"'", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > event_data.json
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "PR事件: ${PR_NUMBER}"
          echo "源分支: ${{ github.event.pull_request.head.ref }}"
          echo "目标分支: ${{ github.event.pull_request.base.ref }}"
          echo "源SHA: ${{ github.event.pull_request.head.sha }}"
          echo "目标SHA: ${{ github.event.pull_request.base.sha }}"
          
          # 尝试获取变更文件的多种方法
          echo "=== 尝试方法1: 使用PR的head和base SHA ==="
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} 2>&1 | head -50 | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$CHANGED_FILES" ] || [ "$CHANGED_FILES" = "fatal: bad object" ]; then
            echo "=== 尝试方法2: 拉取远程分支并比较 ==="
            git fetch origin ${{ github.event.pull_request.base.ref }} 2>&1
            git fetch origin ${{ github.event.pull_request.head.ref }} 2>&1
            CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} 2>&1 | head -50 | tr '\n' ',' | sed 's/,$//')
          fi
          
          if [ -z "$CHANGED_FILES" ] || [ "$CHANGED_FILES" = "fatal: bad object" ]; then
            echo "=== 尝试方法3: 使用当前HEAD与目标分支比较 ==="
            git fetch origin ${{ github.event.pull_request.base.ref }} 2>&1
            CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} 2>&1 | head -50 | tr '\n' ',' | sed 's/,$//')
          fi
          
          echo "变更文件: $CHANGED_FILES"
          
          echo '{"event_type": "pull_request", "repository": "${{ github.repository }}", "pr_number": "${{ github.event.pull_request.number }}", "pr_title": "${{ github.event.pull_request.title }}", "pr_author": "${{ github.event.pull_request.user.login }}", "pr_state": "${{ github.event.pull_request.state }}", "pr_action": "${{ github.event.action }}", "source_branch": "${{ github.event.pull_request.head.ref }}", "target_branch": "${{ github.event.pull_request.base.ref }}", "pr_url": "${{ github.event.pull_request.html_url }}", "changed_files": "'"$CHANGED_FILES"'", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > event_data.json
        fi
        
        echo "=== 事件数据准备完成 ==="
        echo "Event data prepared:"
        cat event_data.json
        
        EVENT_DATA=$(cat event_data.json)
        echo "event_data=$EVENT_DATA" >> $GITHUB_OUTPUT
    
    - name: Send event notification
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        EVENT_DATA: ${{ steps.prepare-data.outputs.event_data }}
      run: |
        if [ -z "$WEBHOOK_URL" ]; then
          echo "Warning: WEBHOOK_URL secret not set. Skipping notification."
          exit 0
        fi
        
        echo "Sending event notification to $WEBHOOK_URL"
        
        curl -s -X POST \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Event: ${{ github.event_name }}" \
          -H "X-GitHub-Repository: ${{ github.repository }}" \
          -d "$EVENT_DATA" \
          "$WEBHOOK_URL"
        
        echo "Notification sent successfully!"
    
    - name: Save event data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: event-data
        path: event_data.json
        retention-days: 7
